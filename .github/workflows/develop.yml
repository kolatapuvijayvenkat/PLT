name: Deploy EB Env to Dev on Merge to Develop

on:
  push:
    branches:
      - develop   # Trigger only on merge/push to develop

permissions:
  id-token: write
  contents: read

jobs:
  create-dev-env:
    name: Create EB Environment in Dev
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Configure AWS Prod Account (to fetch EB config)
      - name: Configure AWS Prod Account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::986906625933:role/OPS_TEST_ROLE
          aws-region: us-east-1

      # 3️⃣ Export Prod EB environment details + configuration
      - name: Export Prod EB Config
        run: |
          # Save full environment details (includes PlatformArn with version)
          aws elasticbeanstalk describe-environments \
            --application-name PLT \
            --environment-names PLT-env \
            > prod-env.json

          # Save configuration separately (includes option settings)
          aws elasticbeanstalk describe-configuration-settings \
            --application-name PLT \
            --environment-name PLT-env \
            > prod-config.json

      # 4️⃣ Configure AWS Dev Account
      - name: Configure AWS Dev Account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::045615335706:role/PLT_Test_Role
          aws-region: us-east-1

            # 5️⃣ Create new configuration template in Dev (from Prod)
      - name: Create EB Config Template in Dev
        run: |
          TEMPLATE_NAME="prod-template-${{ github.run_number }}"
          echo "TEMPLATE_NAME=$TEMPLATE_NAME" >> $GITHUB_ENV

          # Try to get PlatformArn from prod env
          PLATFORM_NAME=$(jq -r '.Environments[0].PlatformArn' prod-env.json | sed 's|^arn:aws:elasticbeanstalk:[^:]*::platform/||')
          SOLUTION_STACK=$(jq -r '.ConfigurationSettings[0].SolutionStackName // empty' prod-config.json)

          if [ -n "$PLATFORM_NAME" ]; then
            echo "Looking up full ARN for platform: $PLATFORM_NAME"
            FULL_PLATFORM_ARN=$(aws elasticbeanstalk list-platform-versions \
              --query "PlatformSummaryList[?contains(PlatformArn, '$PLATFORM_NAME')].PlatformArn | [0]" \
              --output text)

            echo "Resolved PlatformArn: $FULL_PLATFORM_ARN"

            aws elasticbeanstalk create-configuration-template \
              --application-name PLT \
              --template-name "$TEMPLATE_NAME" \
              --platform-arn "$FULL_PLATFORM_ARN" \
              --option-settings file://<(jq -c '.ConfigurationSettings[0].OptionSettings' prod-config.json)
          else
            echo "Using Solution Stack: $SOLUTION_STACK"
            aws elasticbeanstalk create-configuration-template \
              --application-name PLT \
              --template-name "$TEMPLATE_NAME" \
              --solution-stack-name "$SOLUTION_STACK" \
              --option-settings file://<(jq -c '.ConfigurationSettings[0].OptionSettings' prod-config.json)
          fi


      # 6️⃣ Create new Dev EB Environment
      - name: Create EB Environment in Dev
        run: |
          EB_ENV_NAME="dev-env-${{ github.run_number }}"
          echo "EB_ENV_NAME=$EB_ENV_NAME" >> $GITHUB_ENV

          aws elasticbeanstalk create-environment \
            --application-name PLT \
            --environment-name "$EB_ENV_NAME" \
            --template-name "$TEMPLATE_NAME"

      # 7️⃣ Smoke Test the Environment
      - name: Smoke Test Dev Environment
        run: |
          echo "Waiting for environment $EB_ENV_NAME to be ready..."
          aws elasticbeanstalk wait environment-exists --environment-names "$EB_ENV_NAME"
          aws elasticbeanstalk wait environment-ready --environment-names "$EB_ENV_NAME"

          APP_URL=$(aws elasticbeanstalk describe-environments \
            --application-name PLT \
            --environment-names "$EB_ENV_NAME" \
            --query 'Environments[0].CNAME' --output text)

          echo "Testing endpoint: http://$APP_URL"
          curl -f http://$APP_URL || exit 1
